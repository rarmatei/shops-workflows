launch-templates:
  nx-repo-large-js:
    resource-class: 'docker_linux_amd64/medium+'
#    enableDindWithPrivilegedContainers: true
    image: 'us-east1-docker.pkg.dev/nxcloudoperations/nx-cloud-enterprise-public/nx-agents-base-images:ubuntu22.04-node20.9-v4'
    env:
      GIT_AUTHOR_EMAIL: test@test.com
      GIT_AUTHOR_NAME: Test
      GIT_COMMITTER_EMAIL: test@test.com
      GIT_COMMITTER_NAME: Test
#      SELECTED_PM: 'pnpm'
      NPM_CONFIG_PREFIX: '/home/workflows/.npm-global'
    init-steps:
#      - name: sleep
#        script: sleep 1200
      - name: print info
        script: |
          echo "User ID (UID): $(id -u)"
          echo "Group ID (GID): $(id -g)"
          echo "Primary Group Name: $(id -gn)"
          echo "All Group Information: $(id)"
          whoami
      - name: install package
        script: |
          sudo apt-get update
          sudo apt-get install -y tree
      - name: Checkout
        uses: 'nrwl/nx-cloud-workflows/v1.1/workflow-steps/checkout/main.yaml'
      - name: Cache restore
        uses: 'nrwl/nx-cloud-workflows/v1.1/workflow-steps/cache/main.yaml'
        env:
          KEY: 'pnpm-lock.yaml'
          PATHS: |
            node_modules
            ~/.cache/Cypress
            ~/.pnpm-store
          BASE_BRANCH: 'master'

      - name: Install Pnpm
        script: |
          npm install -g @pnpm/exe@8.7.4

      - name: Pnpm Install
        script: |
          pnpm install --frozen-lockfile


      - name: Install Cypress
        script: pnpm exec cypress install

      - name: Install Rust
        script: |
          curl --proto '=https' --tlsv1.3 https://sh.rustup.rs -sSf | sh -s -- -y
          source "$HOME/.cargo/env"
          rustup toolchain install 1.70.0

      - name: Configure git metadata (needed for lerna smoke tests)
        script: |
          git config --global user.email test@test.com
          git config --global user.name "Test Test"

      - name: Load Cargo Env
        script: echo "PATH=$HOME/.cargo/bin:$PATH" >> $NX_CLOUD_ENV
      - name: sleep
        script: sleep 1200
  rares-linux-large-js:
    resourceClass: "docker_linux_amd64/large"
    image: 'us-east1-docker.pkg.dev/nxcloudoperations/nx-cloud-enterprise-public/nx-agents-base-images:ubuntu-22.04-node20.9-v3'
    env:
      NX_CLOUD_ACCESS_TOKEN: '{{secrets.NX_CLOUD_ACCESS_TOKEN}}'
    init-steps:
      - name: checkout repo
        uses: 'nrwl/nx-cloud-workflows/main/workflow-steps/checkout/main.yaml'
#      - name: sleep
#        script: 'sleep $((RANDOM % 120 + 1))'
#      - name: sleep a lot
#        script: sleep 300
#      - name: print lots of logs
#        script: 'yes "This is a line of text." | head -c 5M'
#      - name: sleep
#        script: 'sleep $((RANDOM % 120 + 1))'
#      - name: sleep more
#        script: 'sleep 1200'
#      - name: fail randomly half the time
#        script: 'sleep $((RANDOM % 20 + 1)) && if (( RANDOM % 2 == 0 )); then exit 1; fi'
#      - name: fail randomly half the time
#        script: 'sleep $((RANDOM % 20 + 1)) && if (( RANDOM % 2 == 0 )); then exit 1; fi'
      - name: Cache restore
        uses: 'nrwl/nx-cloud-workflows/v1.1/workflow-steps/cache/main.yaml'
        env:
          KEY: 'pnpm-lock.yaml'
          PATHS: |
            node_modules
            ~/.cache/Cypress
            ~/.pnpm-store
          BASE_BRANCH: 'master'

      - name: Install Pnpm
        script: |
          npm install -g @pnpm/exe@8.7.4

      - name: Pnpm Install
        script: |
          pnpm install --frozen-lockfile

